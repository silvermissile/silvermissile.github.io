在说流式系统的时候，我们在说什么？？
什么不是？
# 引入
> 什么时候需要流式系统？


如果老板丢给你，一批静态海量数据，毫无疑问，这要用批处理系统。“来给我把这100T的日志分析一下”

现实中，只要业务还在开展，每天都有新的数据进来，这个时候分析的需求就会出现这种情况：
- 最近一天的登录用户有多少？
- 最近一个月月活多少？
- 产品上线到目前为止的用户流失率多少？


如果业务如果停掉了，这些都可以用批处理系统来满足，估计是公司关门前最后的工作了。业务没有停掉的话，就是流失系统发挥作用的时候了。

# 澄清
> 什么是流式系统？

从上面可以看出来，**流式系统是是一种能处理无穷数据的数据处理引擎。**
这里需要为以下展开澄清的是：
## streaming batch
- streaming batch是处理数据两种引擎，即：流式数据处理系统，批量数据处理系统柜。
- streaming batch用来描述数据是不准确的，更为本质的说法是，无边界数据和有边界数据

>这个世界上的数据可以抽象成为两种，分别是无边界数据（Unbounded Data）和有边界数据（Bounded Data）。
顾名思义，无边界数据是一种不断增长，可以说是无限的数据集。
这种类型的数据，我们无法判定它们到底什么时候会停止发送。
例如，从手机或者从传感器发送出来的信号数据，又比如我们所熟知的移动支付领域中的交易数据。因为每时每刻都会有交易产生，所以我们不能判定在某一刻这类数据就会停止发送了。

>在国外的一些技术文章上，有时候我们会看到“流数据（Streaming Data）”这一说法，其实它和无边界数据表达的是同一个概念。
与此相反，有边界数据是一种有限的数据集。
这种数据更常见于已经保存好了的数据中。例如，数据库中的数据，或者是我们常见的 CSV 格式文件中的数据。
当然了，你可能会问，那我们把无边界数据按照时间窗口提取一小份出来，那这样的数据是什么数据呢？
拿我们之前提到过的移动支付中的交易数据来说吧。移动支付中的交易数据可以看作是无边界数据。那我们按 2019 年 4 月 29 日这个时间窗口提取出来的数据呢？这个当日的交易数据就变成了有边界数据了。
所以，有边界数据其实可以看作是无边界数据的一个子集。

## 近似
> 什么不是流式系统？
- 为了达到低延迟的效果？经常使用的方法是降低准确性需求，提供近似的准确、推测的结果。这不是流式系统的本质特征。
- 批量系统也可以近似。
- 大数据算法举例。

正确性，是对流式处理系统的合理要求。
## micro batch
>micro batch ,mini batch也能解决无穷数据的分析问题，也是流式系统。
>这里你会觉得，只要把批处理系统的数据分割的足够小，就是流式系统了。这里似乎批处理系统足够强大到一统江湖的地步。后面这里还会展开。


# 必要
>流式系统是必要的：
- 用户体验；业务需求倾向于更加实时的数据，使用流式处理是获得低延迟的一个很好的方式。
- 数据特点：业务中海量无穷数据集越来越常见，使用streaming系统来处理这类永远不会结束的数据更加容易。
  - 不然隔段时间，久全量计算一遍，麻烦
  - 或者隔断时间，某时刻的全量，跟之后的增量合并一次
- 系统维护：随着时间的推移，数据一到达就处理，将工作负载分配得更均匀，使得资源消耗更一致、可预测。


# 局限
>当人家还不成熟的时候
- streaming系统被工业界狭隘地认为是提供低延迟、近似结果，
- 而更有能力的batch系统用来提供最终正确的结果，
- 它们协同构成Lambda架构。

![pic](https://raw.githubusercontent.com/silvermissile/silvermissile.github.io/master/img/post/2019-07-20-e9dk8d.png)

Lambda系统的基本思想就是同时运行一个streaming系统和batch系统，执行同样的计算，streaming系统提供低延迟、不精确的结果(这是因为使用的近似算法，或者系统本身就不支持精确)，之后batch系统继续执行，提供精确的结果。起初这个架构是由Nathna Marz提出来的，他是Storm的创始人，这个想法在当时看起来很不错，因此获得的成功。当时streaming系统在正确性上让人不太满意，batch系统也没有预期的那么好，所以Lambda架构提供了一种短期解决方案，并且很多项目真的用了。但是这种架构也存在问题：维护成本高，需要为我们的工作线维护构建和维护两个独立的系统，最后还要合并它们的结果。

# 质疑
Question Lambda Architecture
Kreps的那篇Question Lambda Architecture。它很有远见地质疑了双引擎的必要性，并给出了很强的理由。Kreps使用一个可重发消息的系统比如Kafka来解决repeatability问题，并且提出一个新的Kappa架构，利用设计良好的系统，只运行一个pipeline。虽然我不认为需要为这个概念重新取一个名字，但是我很支持这个思想。

![pic](https://raw.githubusercontent.com/silvermissile/silvermissile.github.io/master/img/post/2019-07-20-BS1nsp.png)
1. 使用 Kafka 或其他技术保存要处理的全量数据，并且允许多个订阅者订阅数据。
2. 启动流式计算任务（记为第 N 个）开始处理数据。
3. 当需要重新计算时，启动第 N+1 个流式计算任务实例来计算从最初到最新的整个全量数据，但是计算结果输出到新的位置。
4. 但第 N+1 个计算任务处理到最新数据时，把最新的计算结果暴露给外部应用。
5. 停止较早第 N 个的计算任务，删除它的输出结果。

# 造反
> 我来了
坦率地说，我认为现在应该更进一步，我认为设计合理的streaming系统事实上会比batch系统提供更多的功能。到那时也许不再需要batch系统。我很喜欢Flink利用这个思想，构建了一个”任何时刻都是streaming“的系统，并且支持batch模式。

# 克服
正确性
##
## 时间工具
>千里之行，始于足下
>不积跬步，无以至千里

现实情况：乱序事件流
说到底还是个分割无穷的问题。
-
https://www.oreilly.com/ideas/questioning-the-lambda-architecture

#
公司目前就是这样搞的。
